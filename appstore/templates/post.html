{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="post-container">

  <!-- POST INFO container -->
  <div class="post-main-info elevation-2">
    <div class="post-header">
      <h1>{{ post.title }}</h1>
      {% if post.type == 'app' %}
      <div class="post-average-rating" title="Average rating: {{ average_rating }}">
        {% for i in "12345" %}
          {% if forloop.counter <= average_rating %}
            <span class="material-symbols-rounded star filled">star</span>
          {% else %}
            <span class="material-symbols-rounded star">star_border</span>
          {% endif %}
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <div class="post-meta">
      <img src="{% if post.admin.avatar %}{{ post.admin.avatar.url }}{% else %}{% static 'img/default-avatar.png' %}{% endif %}" alt="Avatar" class="comment-avatar"/>
      <span class="meta-item"> {{ post.user.username }} </span>
      <span class="meta-item">
        <span class="material-symbols-rounded">calendar_today</span> {{ post.timestamp }}
      </span>
      <span class="meta-item">
        <span class="material-symbols-rounded">visibility</span> {{ post.views }}
      </span>
      <span class="meta-item">
        <span class="material-symbols-rounded">favorite</span> {{ post.likes.count }}
      </span>
    </div>

    <p class="post-description">{{ post.description }}</p>

    {% if post.categories.exists %}
    <div class="post-categories">
      {% for category in post.categories.all %}
        <span class="category">{{ category.name }}</span>
      {% endfor %}
    </div>
    {% endif %}

    {% if post.type == 'app' and files %}
    <div class="app-files">
      <h3>Download Files</h3>
      <br>
      <ul>
        {% for file in files %}
          <li class="file-item">
            <span class="material-symbols-rounded file-icon">insert_drive_file</span>
            <a href="{{ file.file.url }}" download>{{ file.file.name|slice:"-20:" }}</a>
            <small>({{ file.file.size|filesizeformat }})</small>
          </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div> <!-- end post-main-info -->

  <!-- YOUR REVIEW tab container -->
  {% if post.type == 'app' %} 
  <div class="your-review-container elevation-2">
    <button id="toggle-review-form" class="toggle-btn">Write your review</button>
    <div id="review-form" class="review-form hidden">
      {% if request.user.is_authenticated %}
      <form method="post" action="{% url 'submit_review' post.id %}">
        {% csrf_token %}
        <label for="rating">Rating:</label>
        <select id="rating" name="rating" required>
          {% for i in "12345" %}
          <option value="{{ i }}">{{ i }}</option>
          {% endfor %}
        </select>

        <label for="content">Review:</label>
        <textarea id="content" name="content" rows="4" required></textarea>

        <button type="submit">Submit Review</button>
      </form>
      {% else %}
      <p><a href="{% url 'login' %}">Log in</a> to write a review.</p>
      {% endif %}
    </div>
  </div>

  <!-- REVIEWS container -->
  <div class="post-reviews elevation-2">
    <h3>Reviews</h3>

    <div class="reviews-list">
      {% for review in reviews %}
      <div class="review">
        <div class="review-header">
          <strong>{{ review.user.username }}</strong>
          <div class="review-stars">
            {% for i in "12345" %}
              {% if forloop.counter <= review.rating %}
                <span class="material-symbols-rounded star filled">star</span>
              {% else %}
                <span class="material-symbols-rounded star">star_border</span>
              {% endif %}
            {% endfor %}
          </div>
          <small>{{ review.timestamp|date:"M d, Y" }}</small>
        </div>
        <p>{{ review.content }}</p>
        {% if request.user.is_superuser or review.user == request.user %}
          <form method="post" action="{% url 'delete_review' review.id %}">
            {% csrf_token %}
            <button class="delete-btn" type="submit">Delete</button>
          </form>
        {% endif %}
      </div>
      {% empty %}
        <p>No reviews yet.</p>
      {% endfor %}
    </div>
  </div>
  {% else %}
    <div class="comment-form-container">
      <form method="post" class="comment-form">
        {% csrf_token %}
        <div class="comment-user-info">
          <img src="{% if user.profile.avatar %}{{ user.profile.avatar.url }}{% else %}{% static 'img/default-avatar.png' %}{% endif %}" alt="Avatar" class="comment-avatar"/>
          <span>{{ user.username }}</span>
        </div>
        <div class="comment-form-input">
          <textarea name="content" rows="2" placeholder="Write your comment..." required></textarea>
          <button type="submit">Post</button>
        </div>
      </form>
    </div>
    <div class="comment-container">
      <div class="comments-section">
        <h3>Comments</h3>
        <div class="comments-list">
          {% if comments %}
            {% for comment in comments %}
              <div class="comment">
                <div class="comment-header">
                  <strong>{{ comment.user.username }}</strong>
                  <span class="comment-date">{{ comment.timestamp }}</span>
                </div>
                <p>{{ comment.content }}</p>
              </div>
            {% endfor %}
          {% else %}
            <p>No comments yet.</p>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}
</div>

<script src="{% static 'js/review_form.js' %}"></script>
{% endblock %}
